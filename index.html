<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethiopia Economic Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background-color: #046a38;
            color: white;
            border-radius: 5px;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .data-table {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #666;
        }

        footer a {
            color: #046a38;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            h1 {
                font-size: 1.8rem;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- HTML Structure -->
    <header>
        <h1>Ethiopia Economic Dashboard</h1>
        <p>Interactive visualization of economic indicators</p>
    </header>

    <main>
        <section class="controls">
            <div class="control-group">
                <label for="indicator">Economic Indicator:</label>
                <select id="indicator">
                    <option value="NY.GDP.MKTP.CD">GDP (current US$)</option>
                    <option value="NY.GDP.MKTP.KD.ZG">GDP growth (annual %)</option>
                    <option value="FP.CPI.TOTL.ZG">Inflation, consumer prices (annual %)</option>
                    <option value="SL.UEM.TOTL.ZS">Unemployment, total (% of total labor force)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="years">Time Range:</label>
                <select id="years">
                    <option value="10">Last 10 years</option>
                    <option value="20">Last 20 years</option>
                    <option value="30">Last 30 years</option>
                    <option value="all">All available data</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="compare">Compare with:</label>
                <select id="compare">
                    <option value="none">No comparison</option>
                    <option value="KEN">Kenya</option>
                    <option value="SDN">Sudan</option>
                    <option value="SSD">South Sudan</option>
                    <option value="DJI">Djibouti</option>
                </select>
            </div>
        </section>

        <section class="chart-container">
            <div id="loadingIndicator" class="loading">Loading data...</div>
            <canvas id="economicChart"></canvas>
        </section>

        <section class="data-table">
            <h2>Data Table</h2>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be inserted here by JavaScript -->
                </tbody>
            </table>
        </section>
    </main>

    <footer>
        <p>Data source: <a href="https://data.worldbank.org/" target="_blank">World Bank Open Data</a></p>
        <p>Â© <span id="currentYear"></span> Ethiopia Economic Dashboard</p>
    </footer>

    <!-- JavaScript Code -->
    <script>
        // Global variables
        let economicChart = null;
        const CACHE_EXPIRY_DAYS = 1;
        
        // Sample data for when API fails (fallback)
        const SAMPLE_DATA = {
            "NY.GDP.MKTP.CD": [
                {date: "2020", value: 1076.5, country: {id: "ETH", value: "Ethiopia"}, indicator: {id: "NY.GDP.MKTP.CD", value: "GDP (current US$)"}},
                {date: "2019", value: 9591.2, country: {id: "ETH", value: "Ethiopia"}, indicator: {id: "NY.GDP.MKTP.CD", value: "GDP (current US$)"}},
                {date: "2018", value: 8426.8, country: {id: "ETH", value: "Ethiopia"}, indicator: {id: "NY.GDP.MKTP.CD", value: "GDP (current US$)"}},
                {date: "2017", value: 8089.3, country: {id: "ETH", value: "Ethiopia"}, indicator: {id: "NY.GDP.MKTP.CD", value: "GDP (current US$)"}},
                {date: "2016", value: 7443.4, country: {id: "ETH", value: "Ethiopia"}, indicator: {id: "NY.GDP.MKTP.CD", value: "GDP (current US$)"}}
            ],
            "NY.GDP.MKTP.KD.ZG": [
                {date: "2020", value: 6.1, country: {id: "ETH", value: "Ethiopia"}, indicator: {id: "NY.GDP.MKTP.KD.ZG", value: "GDP growth (annual %)"}},
                {date: "2019", value: 9.0, country: {id: "ETH", value: "Ethiopia"}, indicator: {id: "NY.GDP.MKTP.KD.ZG", value: "GDP growth (annual %)"}},
                {date: "2018", value: 7.7, country: {id: "ETH", value: "Ethiopia"}, indicator: {id: "NY.GDP.MKTP.KD.ZG", value: "GDP growth (annual %)"}},
                {date: "2017", value: 10.2, country: {id: "ETH", value: "Ethiopia"}, indicator: {id: "NY.GDP.MKTP.KD.ZG", value: "GDP growth (annual %)"}},
                {date: "2016", value: 8.0, country: {id: "ETH", value: "Ethiopia"}, indicator: {id: "NY.GDP.MKTP.KD.ZG", value: "GDP growth (annual %)"}}
            ]
        };

        // Main initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Initialize with default values
            updateChart();
            
            // Add event listeners for controls
            document.getElementById('indicator').addEventListener('change', updateChart);
            document.getElementById('years').addEventListener('change', updateChart);
            document.getElementById('compare').addEventListener('change', updateChart);
        });

        function updateChart() {
            const indicator = document.getElementById('indicator').value;
            const years = document.getElementById('years').value;
            const compareCountry = document.getElementById('compare').value;
            
            showLoading(true);
            
            // Fetch main data
            fetchData('ETH', indicator, years).then(data => {
                processData(data, 'ETH');
                
                // Fetch comparison data if selected
                if (compareCountry !== 'none') {
                    fetchData(compareCountry, indicator, years).then(compareData => {
                        window.comparisonData = processComparisonData(compareData, compareCountry);
                        updateChartDisplay();
                        showLoading(false);
                    }).catch(() => {
                        updateChartDisplay();
                        showLoading(false);
                    });
                } else {
                    window.comparisonData = null;
                    updateChartDisplay();
                    showLoading(false);
                }
            }).catch(() => {
                // If API fails, use sample data
                console.log("Using sample data");
                const sampleData = SAMPLE_DATA[indicator] || SAMPLE_DATA["NY.GDP.MKTP.CD"];
                processData(sampleData, 'ETH');
                updateChartDisplay();
                showLoading(false);
            });
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('economicChart').style.display = show ? 'none' : 'block';
        }

        async function fetchData(countryCode, indicator, years) {
            const currentYear = new Date().getFullYear();
            const startYear = years === 'all' ? 1960 : currentYear - parseInt(years);
            
            // Check cache first
            const cacheKey = `wb_${countryCode}_${indicator}_${startYear}_${currentYear}`;
            const cachedData = getFromCache(cacheKey);
            
            if (cachedData) {
                return cachedData;
            }
            
            const url = `https://api.worldbank.org/v2/country/${countryCode}/indicator/${indicator}?format=json&date=${startYear}:${currentYear}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("API request failed");
                
                const data = await response.json();
                if (data && data[1]) {
                    saveToCache(cacheKey, data[1]);
                    return data[1];
                } else {
                    throw new Error("No data received");
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                throw error;
            }
        }

        function getFromCache(key) {
            const item = localStorage.getItem(key);
            if (!item) return null;
            
            const { data, timestamp } = JSON.parse(item);
            const now = new Date().getTime();
            
            // Check if cache is expired (1 day)
            if (now - timestamp > CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000) {
                localStorage.removeItem(key);
                return null;
            }
            
            return data;
        }

        function saveToCache(key, data) {
            const item = {
                data: data,
                timestamp: new Date().getTime()
            };
            localStorage.setItem(key, JSON.stringify(item));
        }

        function processData(data, countryCode) {
            // Filter out null values and sort by year
            const filteredData = data.filter(item => item.value !== null)
                                    .sort((a, b) => a.date - b.date);
            
            // Store the processed data
            window.mainData = {
                country: getCountryName(countryCode),
                indicator: data[0]?.indicator?.value || document.getElementById('indicator').selectedOptions[0].text,
                years: filteredData.map(item => item.date),
                values: filteredData.map(item => item.value),
                rawData: filteredData
            };
            
            updateDataTable(filteredData);
        }

        function processComparisonData(data, countryCode) {
            // Filter out null values and sort by year
            const filteredData = data.filter(item => item.value !== null)
                                    .sort((a, b) => a.date - b.date);
            
            return {
                country: getCountryName(countryCode),
                indicator: data[0]?.indicator?.value || document.getElementById('indicator').selectedOptions[0].text,
                years: filteredData.map(item => item.date),
                values: filteredData.map(item => item.value)
            };
        }

        function getCountryName(countryCode) {
            const countryNames = {
                'ETH': 'Ethiopia',
                'KEN': 'Kenya',
                'SDN': 'Sudan',
                'SSD': 'South Sudan',
                'DJI': 'Djibouti'
            };
            
            return countryNames[countryCode] || countryCode;
        }

        function updateDataTable(data) {
            const tableBody = document.querySelector('#dataTable tbody');
            tableBody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                
                const yearCell = document.createElement('td');
                yearCell.textContent = item.date;
                row.appendChild(yearCell);
                
                const valueCell = document.createElement('td');
                valueCell.textContent = item.value !== null ? formatValue(item.value, document.getElementById('indicator').value) : 'N/A';
                row.appendChild(valueCell);
                
                tableBody.appendChild(row);
            });
        }

        function formatValue(value, indicatorCode) {
            if (indicatorCode === 'NY.GDP.MKTP.CD') {
                // Format as currency
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    maximumFractionDigits: 0
                }).format(value);
            } else if (indicatorCode === 'NY.GDP.MKTP.KD.ZG' || 
                      indicatorCode === 'FP.CPI.TOTL.ZG' || 
                      indicatorCode === 'SL.UEM.TOTL.ZS') {
                // Format as percentage
                return value.toFixed(2) + '%';
            }
            return value.toLocaleString();
        }

        function updateChartDisplay() {
            const ctx = document.getElementById('economicChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (economicChart) {
                economicChart.destroy();
            }
            
            // Check if we have data to display
            if (!window.mainData) {
                return;
            }
            
            // Prepare datasets
            const datasets = [];
            
            datasets.push({
                label: window.mainData.country,
                data: window.mainData.values,
                borderColor: '#046a38',
                backgroundColor: 'rgba(4, 106, 56, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.1
            });
            
            if (window.comparisonData) {
                datasets.push({
                    label: window.comparisonData.country,
                    data: window.comparisonData.values,
                    borderColor: '#da291c',
                    backgroundColor: 'rgba(218, 41, 28, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1
                });
            }
            
            // Create new chart
            economicChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: window.mainData.years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: window.mainData.indicator,
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.raw;
                                    label += formatTooltipValue(value, document.getElementById('indicator').value);
                                    return label;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: getYAxisTitle(document.getElementById('indicator').value)
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    }
                }
            });
        }

        function formatTooltipValue(value, indicatorCode) {
            if (indicatorCode === 'NY.GDP.MKTP.CD') {
                // Format as currency
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    maximumFractionDigits: 0
                }).format(value);
            } else if (indicatorCode === 'NY.GDP.MKTP.KD.ZG' || 
                      indicatorCode === 'FP.CPI.TOTL.ZG' || 
                      indicatorCode === 'SL.UEM.TOTL.ZS') {
                // Format as percentage
                return value.toFixed(2) + '%';
            }
            return value.toLocaleString();
        }

        function getYAxisTitle(indicatorCode) {
            const titles = {
                'NY.GDP.MKTP.CD': 'US Dollars',
                'NY.GDP.MKTP.KD.ZG': 'Percentage',
                'FP.CPI.TOTL.ZG': 'Percentage',
                'SL.UEM.TOTL.ZS': 'Percentage'
            };
            return titles[indicatorCode] || 'Value';
        }
    </script>
</body>
</html>
